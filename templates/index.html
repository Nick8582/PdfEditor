<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PDF Editor - –í–µ–± –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow: auto;
            touch-action: pan-y;
        }
        
        .toolbar {
            background: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }
        
        .toolbar button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .toolbar button:active {
            background: #2980b9;
            transform: scale(0.95);
        }
        
        .toolbar button.active {
            background: #e74c3c;
        }
        
        .toolbar .separator {
            width: 1px;
            height: 24px;
            background: #555;
            margin: 0 4px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #ddd;
            -webkit-overflow-scrolling: touch;
        }
        
        #pdfCanvas {
            display: block;
            margin: 20px auto;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            touch-action: none;
            -ms-touch-action: none;
            cursor: crosshair;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }
        
        .sidebar.active {
            display: block;
        }
        
        .info-panel {
            margin-bottom: 20px;
        }
        
        .info-panel h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .info-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        .info-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            cursor: pointer;
        }
        
        .info-list li:active {
            background: #f0f0f0;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #34495e;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            z-index: 100;
        }
        
        .file-input {
            display: none;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .zoom-controls button {
            min-width: 40px;
            padding: 6px 10px;
        }
        
        .page-info {
            margin: 0 10px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                right: -300px;
                top: 60px;
                bottom: 40px;
                width: 300px;
                transition: right 0.3s;
                z-index: 200;
            }
            
            .sidebar.active {
                right: 0;
            }
            
            .toolbar {
                padding: 8px;
            }
            
            .toolbar button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <input type="file" id="fileInput" class="file-input" accept=".pdf">
        <button onclick="document.getElementById('fileInput').click()">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å PDF</button>
        
        <div class="separator"></div>
        
        <button id="deleteBtn" onclick="setMode('delete')">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ</button>
        <button id="colorBtn" onclick="setMode('color')">üé® –ó–∞–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞</button>
        <button id="eyedropperBtn" onclick="setMode('eyedropper')">üíß –ü–∏–ø–µ—Ç–∫–∞</button>
        <button id="insertBtn" onclick="setMode('insert')">‚ûï –í—Å—Ç–∞–≤–∏—Ç—å</button>
        <button id="removeBtn" onclick="setMode('remove')">‚úÇÔ∏è –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
        
        <div class="separator"></div>
        
        <button onclick="clearPage()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button onclick="toggleSidebar()">üìã –°–ø–∏—Å–æ–∫</button>
        
        <div class="separator"></div>
        
        <div class="zoom-controls">
            <button onclick="zoomOut()">‚àí</button>
            <span class="page-info" id="pageInfo">–°—Ç—Ä. 0/0</span>
            <button onclick="zoomIn()">+</button>
        </div>
        
        <button onclick="prevPage()">‚óÄ</button>
        <button onclick="nextPage()">‚ñ∂</button>
        
        <div class="separator"></div>
        
        <button onclick="applyToPages()">üìã –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö</button>
        <button onclick="savePDF()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    <div class="main-container">
        <div class="canvas-container" id="canvasContainer">
            <div id="loadingMessage" style="text-align: center; padding: 50px; color: #666;">
                <h2>PDF Editor</h2>
                <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
            </div>
            <canvas id="pdfCanvas" style="display: none;"></canvas>
        </div>
        
        <div class="sidebar" id="sidebar">
            <div class="info-panel">
                <h3>–û–±–ª–∞—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è</h3>
                <ul class="info-list" id="deletionList"></ul>
            </div>
            
            <div class="info-panel">
                <h3>–ó–∞–º–µ–Ω—ã —Ü–≤–µ—Ç–∞</h3>
                <ul class="info-list" id="colorList"></ul>
            </div>
            
            <div class="info-panel">
                <h3>–í—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</h3>
                <ul class="info-list" id="contentList"></ul>
            </div>
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) -->
    <div id="debugInfo" style="position: fixed; top: 60px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-size: 11px; max-width: 200px; display: none; z-index: 1000;">
        <div>–°—Ç–∞—Ç—É—Å: <span id="debugStatus">-</span></div>
        <div>–°—Ç—Ä–∞–Ω–∏—Ü–∞: <span id="debugPage">-</span></div>
        <div>–°–µ—Å—Å–∏—è: <span id="debugSession">-</span></div>
    </div>
    
    <script>
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ –Ω–∞ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä
        document.getElementById('statusBar').addEventListener('dblclick', function() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        });
        
        function updateDebugInfo() {
            document.getElementById('debugStatus').textContent = pdfDoc ? 'PDF –∑–∞–≥—Ä—É–∂–µ–Ω' : '–û–∂–∏–¥–∞–Ω–∏–µ';
            document.getElementById('debugPage').textContent = currentPage + 1 + '/' + totalPages;
            document.getElementById('debugSession').textContent = sessionId.substring(0, 20) + '...';
        }
        
        setInterval(updateDebugInfo, 1000);
    </script>
    
    <script>
        let pdfDoc = null;
        let currentPage = 0;
        let totalPages = 0;
        let zoom = 1.0;
        let sessionId = 'session_' + Date.now();
        let selectionMode = null;
        let startX = null, startY = null;
        let selectionRect = null;
        let canvas, ctx;
        let pageWidth = 0, pageHeight = 0;
        let canvasWidth = 0, canvasHeight = 0;
        let touchStartX = null, touchStartY = null;
        let isPanning = false;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
        function checkServerConnection() {
            fetch('/health')
                .then(res => res.json())
                .then(data => {
                    console.log('–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω:', data);
                    updateStatus('–°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª.');
                })
                .catch(err => {
                    console.error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', err);
                    updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.');
                });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            try {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
                checkServerConnection();
                
                canvas = document.getElementById('pdfCanvas');
                if (!canvas) {
                    console.error('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    updateStatus('–û—à–∏–±–∫–∞: Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç Canvas!');
                    updateStatus('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Canvas');
                    return;
                }
                
                console.log('Canvas –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                } else {
                    console.error('FileInput –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                }
                
                // –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                
                // –°–µ–Ω—Å–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è iPad - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ mouse —Å–æ–±—ã—Ç–∏—è–º–∏
                canvas.addEventListener('touchstart', handleTouchStart, {passive: false, capture: true});
                canvas.addEventListener('touchmove', handleTouchMove, {passive: false, capture: true});
                canvas.addEventListener('touchend', handleTouchEnd, {passive: false, capture: true});
                canvas.addEventListener('touchcancel', handleTouchEnd, {passive: false, capture: true});
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∂–µ—Å—Ç–∞–º–∏
                document.addEventListener('gesturestart', e => e.preventDefault());
                document.addEventListener('gesturechange', e => e.preventDefault());
                document.addEventListener('gestureend', e => e.preventDefault());
                
                console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JavaScript
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript –æ—à–∏–±–∫–∞:', msg, '–≤', url, '—Å—Ç—Ä–æ–∫–∞', lineNo);
            updateStatus('–û—à–∏–±–∫–∞: ' + msg);
            return false;
        };
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('session_id', sessionId);
            
            updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ PDF...');
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(res => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', res.status);
                if (!res.ok) {
                    throw new Error('HTTP –æ—à–∏–±–∫–∞: ' + res.status);
                }
                return res.json();
            })
            .then(data => {
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                if (data.success) {
                    pdfDoc = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ PDF –∑–∞–≥—Ä—É–∂–µ–Ω
                    totalPages = data.total_pages;
                    currentPage = 0;
                    loadPage(0);
                    updateStatus('PDF –∑–∞–≥—Ä—É–∂–µ–Ω: ' + file.name);
                    console.log('PDF —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω, —Å—Ç—Ä–∞–Ω–∏—Ü:', totalPages);
                } else {
                    const errorMsg = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorMsg);
                    alert('–û—à–∏–±–∫–∞: ' + errorMsg);
                    updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + errorMsg);
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
                updateStatus('–û—à–∏–±–∫–∞: ' + err.message);
            });
        }
        
        function loadPage(pageNum, applyChanges = true) {
            if (pageNum < 0 || pageNum >= totalPages) return;
            
            currentPage = pageNum;
            updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ' + (pageNum + 1) + '...');
            
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', pageNum, 'applyChanges:', applyChanges);
            
            // –í—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            fetch(`/api/page/${pageNum}?session_id=${sessionId}&zoom=${zoom}&apply_changes=true`)
            .then(res => {
                console.log('–û—Ç–≤–µ—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', res.status);
                if (!res.ok) {
                    throw new Error('HTTP –æ—à–∏–±–∫–∞: ' + res.status);
                }
                return res.json();
            })
            .then(data => {
                console.log('–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–µ–Ω—ã:', data);
                if (data.success) {
                    const img = new Image();
                    img.onerror = function() {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    };
                    img.onload = function() {
                        try {
                            canvasWidth = data.width;
                            canvasHeight = data.height;
                            pageWidth = data.page_width;
                            pageHeight = data.page_height;
                            
                            canvas.width = canvasWidth;
                            canvas.height = canvasHeight;
                            ctx.drawImage(img, 0, 0);
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                            canvas.style.display = 'block';
                            const loadingMsg = document.getElementById('loadingMessage');
                            if (loadingMsg) loadingMsg.style.display = 'none';
                            
                            updatePageInfo();
                            updateStatus('–°—Ç—Ä–∞–Ω–∏—Ü–∞ ' + (pageNum + 1) + ' –∏–∑ ' + totalPages);
                            updateInfoPanels();
                            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
                            updateStatus('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
                        }
                    };
                    img.src = data.image;
                } else {
                    const errorMsg = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorMsg);
                    alert('–û—à–∏–±–∫–∞: ' + errorMsg);
                    updateStatus('–û—à–∏–±–∫–∞: ' + errorMsg);
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + err.message);
                updateStatus('–û—à–∏–±–∫–∞: ' + err.message);
            });
        }
        
        function setMode(mode) {
            selectionMode = mode;
            document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
            
            const modeMap = {
                'delete': 'deleteBtn',
                'color': 'colorBtn',
                'eyedropper': 'eyedropperBtn',
                'insert': 'insertBtn',
                'remove': 'removeBtn'
            };
            
            if (modeMap[mode]) {
                document.getElementById(modeMap[mode]).classList.add('active');
            }
            
            const modeText = {
                'delete': '–†–µ–∂–∏–º: –í—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è',
                'color': '–†–µ–∂–∏–º: –ó–∞–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞',
                'eyedropper': '–†–µ–∂–∏–º: –ü–∏–ø–µ—Ç–∫–∞',
                'insert': '–†–µ–∂–∏–º: –í—Å—Ç–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
                'remove': '–†–µ–∂–∏–º: –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞'
            };
            
            updateStatus(modeText[mode] || '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        }
        
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
        }
        
        function canvasToPageCoords(canvasX, canvasY) {
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ canvas –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—Ç—Å—Ç—É–ø–æ–º 20px
            const offset = 20 * zoom;
            return {
                x: (canvasX - offset) / zoom,
                y: (canvasY - offset) / zoom
            };
        }
        
        function handleEyedropper(canvasX, canvasY) {
            // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –ø–∏–∫—Å–µ–ª—è –∏–∑ canvas
            try {
                const imageData = ctx.getImageData(Math.floor(canvasX), Math.floor(canvasY), 1, 1);
                const r = imageData.data[0];
                const g = imageData.data[1];
                const b = imageData.data[2];
                
                const hexColor = '#' + [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
                
                console.log('–¶–≤–µ—Ç –ø–∏–∫—Å–µ–ª—è:', hexColor, 'RGB:', r, g, b);
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ü–≤–µ—Ç
                const newColor = prompt('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç: ' + hexColor + '\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ü–≤–µ—Ç (hex):', '#FF0000');
                if (!newColor) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const pageCoords = canvasToPageCoords(canvasX, canvasY);
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ–ø—É—Å–∫
                const tolerance = parseInt(prompt('–î–æ–ø—É—Å–∫ –¥–ª—è –∑–∞–º–µ–Ω—ã —Ü–≤–µ—Ç–∞ (0-255, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30):', '30')) || 30;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–º–µ–Ω—É —Ü–≤–µ—Ç–∞
                fetch('/api/add_color_replacement', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: sessionId,
                        page_num: currentPage,
                        old_color: hexColor,
                        new_color: newColor,
                        tolerance: tolerance
                    })
                })
                .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            console.log('–ó–∞–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
                            setTimeout(() => loadPage(currentPage, true), 100);
                            updateInfoPanels();
                            updateStatus('–¶–≤–µ—Ç –∑–∞–º–µ–Ω–µ–Ω: ' + hexColor + ' ‚Üí ' + newColor);
                        } else {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω—ã —Ü–≤–µ—Ç–∞:', data.error);
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', err);
                    alert('–û—à–∏–±–∫–∞: ' + err.message);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç –ø–∏–∫—Å–µ–ª—è');
            }
        }
        
        function handleMouseDown(e) {
            if (!pdfDoc || selectionMode === null) return;
            
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            if (selectionMode === 'insert') {
                showInsertDialog(pageCoords.x, pageCoords.y);
                return;
            }
            
            if (selectionMode === 'eyedropper') {
                handleEyedropper(coords.x, coords.y);
                return;
            }
            
            if (selectionMode === 'delete' || selectionMode === 'color') {
                startX = pageCoords.x;
                startY = pageCoords.y;
                
                if (selectionRect) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    loadPage(currentPage, true);
                }
            }
        }
        
        function handleMouseMove(e) {
            if (!pdfDoc || !startX || !startY) return;
            
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            if (selectionMode === 'delete' || selectionMode === 'color') {
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º canvas —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                loadPage(currentPage, true);
                
                // –†–∏—Å—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –≤—ã–¥–µ–ª–µ–Ω–∏—è
                ctx.strokeStyle = selectionMode === 'delete' ? 'red' : 'blue';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(
                    startX * zoom + 20 * zoom,
                    startY * zoom + 20 * zoom,
                    (pageCoords.x - startX) * zoom,
                    (pageCoords.y - startY) * zoom
                );
            }
        }
        
        function handleMouseUp(e) {
            if (!pdfDoc || !startX || !startY) return;
            
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            if (selectionMode === 'delete') {
                const area = [
                    Math.min(startX, pageCoords.x),
                    Math.min(startY, pageCoords.y),
                    Math.max(startX, pageCoords.x),
                    Math.max(startY, pageCoords.y)
                ];
                
                fetch('/api/add_deletion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: sessionId,
                        page_num: currentPage,
                        area: area
                    })
                })
                .then(() => {
                    loadPage(currentPage, true);
                    updateInfoPanels();
                });
            } else if (selectionMode === 'color') {
                const area = [
                    Math.min(startX, pageCoords.x),
                    Math.min(startY, pageCoords.y),
                    Math.max(startX, pageCoords.x),
                    Math.max(startY, pageCoords.y)
                ];
                
                const newColor = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ü–≤–µ—Ç (hex, –Ω–∞–ø—Ä–∏–º–µ—Ä #FF0000):', '#FF0000');
                if (newColor) {
                    fetch('/api/add_color_change', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: sessionId,
                            page_num: currentPage,
                            area: area,
                            orig_color: '#000000',
                            new_color: newColor
                        })
                    })
                    .then(() => {
                        loadPage(currentPage, true);
                        updateInfoPanels();
                    });
                }
            }
            
            startX = null;
            startY = null;
        }
        
        // –°–µ–Ω—Å–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è iPad - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        let isDrawing = false;
        let lastTouchX = null;
        let lastTouchY = null;
        let cachedImage = null; // –ö—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
        let initialDistance = null; // –î–ª—è –∂–µ—Å—Ç–æ–≤ –∑—É–º–∞
        let initialZoom = null;
        
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                // –î–≤–∞ –ø–∞–ª—å—Ü–∞ - –∂–µ—Å—Ç –∑—É–º–∞
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                initialDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                initialZoom = zoom;
                isPanning = true;
                return;
            }
            
            if (e.touches.length !== 1) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            isPanning = false;
            isDrawing = false;
            
            const touch = e.touches[0];
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            console.log('Touch start:', coords, pageCoords, 'mode:', selectionMode);
            
            if (!pdfDoc || selectionMode === null) {
                console.log('PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ —Ä–µ–∂–∏–º –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            if (selectionMode === 'insert') {
                showInsertDialog(pageCoords.x, pageCoords.y);
                return;
            }
            
            if (selectionMode === 'eyedropper') {
                // –ü–∏–ø–µ—Ç–∫–∞ - –ø–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –ø–∏–∫—Å–µ–ª—è
                handleEyedropper(coords.x, coords.y);
                return;
            }
            
            if (selectionMode === 'delete' || selectionMode === 'color') {
                isDrawing = true;
                startX = pageCoords.x;
                startY = pageCoords.y;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                cachedImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                console.log('–ù–∞—á–∞–ª–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è:', startX, startY);
            }
        }
        
        function handleTouchMove(e) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–µ—Å—Ç–∞ –∑—É–º–∞ –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏
            if (e.touches.length === 2 && initialDistance !== null) {
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                const scale = currentDistance / initialDistance;
                const newZoom = initialZoom * scale;
                zoom = Math.max(0.2, Math.min(5.0, newZoom));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –∑—É–º–æ–º
                loadPage(currentPage, true);
                return;
            }
            
            if (e.touches.length !== 1 || isPanning) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            if (!isDrawing || !pdfDoc || !startX || !startY) {
                return;
            }
            
            const touch = e.touches[0];
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (cachedImage) {
                ctx.putImageData(cachedImage, 0, 0);
            }
            
            // –†–∏—Å—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            const canvasStartX = startX * zoom + 20 * zoom;
            const canvasStartY = startY * zoom + 20 * zoom;
            const canvasEndX = pageCoords.x * zoom + 20 * zoom;
            const canvasEndY = pageCoords.y * zoom + 20 * zoom;
            
            ctx.strokeStyle = selectionMode === 'delete' ? 'red' : 'blue';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(
                Math.min(canvasStartX, canvasEndX),
                Math.min(canvasStartY, canvasEndY),
                Math.abs(canvasEndX - canvasStartX),
                Math.abs(canvasEndY - canvasStartY)
            );
            
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
        }
        
        function handleTouchEnd(e) {
            // –°–±—Ä–æ—Å –∂–µ—Å—Ç–∞ –∑—É–º–∞
            if (e.touches.length === 0 || e.touches.length === 1) {
                initialDistance = null;
                initialZoom = null;
            }
            
            if (e.changedTouches.length !== 1 || isPanning) {
                isPanning = false;
                isDrawing = false;
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            if (!isDrawing || !pdfDoc || !startX || !startY) {
                isDrawing = false;
                return;
            }
            
            const touch = e.changedTouches[0];
            const coords = getCanvasCoordinates(e);
            const pageCoords = canvasToPageCoords(coords.x, coords.y);
            
            console.log('Touch end:', pageCoords, 'start:', startX, startY);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏
            const minSize = 5;
            const width = Math.abs(pageCoords.x - startX);
            const height = Math.abs(pageCoords.y - startY);
            
            if (width < minSize || height < minSize) {
                console.log('–û–±–ª–∞—Å—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞');
                isDrawing = false;
                startX = null;
                startY = null;
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (cachedImage) {
                    ctx.putImageData(cachedImage, 0, 0);
                }
                return;
            }
            
            const area = [
                Math.min(startX, pageCoords.x),
                Math.min(startY, pageCoords.y),
                Math.max(startX, pageCoords.x),
                Math.max(startY, pageCoords.y)
            ];
            
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏:', area);
            
            if (selectionMode === 'delete') {
                fetch('/api/add_deletion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: sessionId,
                        page_num: currentPage,
                        area: area
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log('–û–±–ª–∞—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
                        setTimeout(() => loadPage(currentPage, true), 100);
                        updateInfoPanels();
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏:', data.error);
                        alert('–û—à–∏–±–∫–∞: ' + data.error);
                    }
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', err);
                    alert('–û—à–∏–±–∫–∞: ' + err.message);
                });
            } else if (selectionMode === 'color') {
                const newColor = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ü–≤–µ—Ç (hex, –Ω–∞–ø—Ä–∏–º–µ—Ä #FF0000):', '#FF0000');
                if (newColor) {
                    fetch('/api/add_color_change', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: sessionId,
                            page_num: currentPage,
                            area: area,
                            orig_color: '#000000',
                            new_color: newColor
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                    if (data.success) {
                        console.log('–ó–∞–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
                        setTimeout(() => loadPage(currentPage, true), 100);
                        updateInfoPanels();
                    } else {
                            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω—ã —Ü–≤–µ—Ç–∞:', data.error);
                            alert('–û—à–∏–±–∫–∞: ' + data.error);
                        }
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', err);
                        alert('–û—à–∏–±–∫–∞: ' + err.message);
                    });
                }
            }
            
            isDrawing = false;
            startX = null;
            startY = null;
            cachedImage = null;
        }
        
        function zoomIn() {
            zoom = Math.min(zoom * 1.2, 5.0);
            loadPage(currentPage, true);
        }
        
        function zoomOut() {
            zoom = Math.max(zoom / 1.2, 0.2);
            loadPage(currentPage, true);
        }
        
        function prevPage() {
            if (currentPage > 0) {
                loadPage(currentPage - 1, true);
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages - 1) {
                loadPage(currentPage + 1, true);
            }
        }
        
        function clearPage() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ?')) return;
            
            fetch('/api/clear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId,
                    page_num: currentPage
                })
            })
            .then(() => {
                loadPage(currentPage, true);
                updateInfoPanels();
            });
        }
        
        function savePDF() {
            updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PDF...');
            
            fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId
                })
            })
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'edited.pdf';
                a.click();
                window.URL.revokeObjectURL(url);
                updateStatus('PDF —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            })
            .catch(err => {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err);
                updateStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            });
        }
        
        function showInsertDialog(x, y) {
            const type = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (text/image):', 'text');
            if (!type) return;
            
            if (type === 'text') {
                const text = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç:');
                if (!text) return;
                
                const fontSize = parseInt(prompt('–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:', '12')) || 12;
                const color = prompt('–¶–≤–µ—Ç (hex):', '#000000') || '#000000';
                
                fetch('/api/add_content', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: sessionId,
                        page_num: currentPage,
                        type: 'text',
                        x: x,
                        y: y,
                        data: {
                            text: text,
                            font_size: fontSize,
                            color: color
                        }
                    })
                })
                .then(() => {
                    loadPage(currentPage, true);
                    updateInfoPanels();
                });
            } else if (type === 'image') {
                alert('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }
        
        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = 
                `–°—Ç—Ä. ${currentPage + 1}/${totalPages} (${Math.round(zoom * 100)}%)`;
        }
        
        function updateStatus(text) {
            document.getElementById('statusBar').textContent = text;
        }
        
        function updateInfoPanels() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π API endpoint
            // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function applyToPages() {
            if (!pdfDoc || totalPages === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const dialog = document.createElement('div');
            dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto;';
            
            content.innerHTML = `
                <h2>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö</h2>
                <p>–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: ${currentPage + 1}</p>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:</p>
                <div id="pagesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0;"></div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="selectAllPages()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px;">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button onclick="deselectAllPages()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 5px;">–°–Ω—è—Ç—å –≤—Å–µ</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="confirmApplyToPages()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button onclick="closeApplyDialog()" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // –°–æ–∑–¥–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü
            const pagesList = document.getElementById('pagesList');
            const pageCheckboxes = [];
            
            for (let i = 0; i < totalPages; i++) {
                if (i === currentPage) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                
                const label = document.createElement('label');
                label.style.cssText = 'display: block; padding: 5px; cursor: pointer;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = i;
                checkbox.style.marginRight = '8px';
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${i + 1}`));
                
                pagesList.appendChild(label);
                pageCheckboxes.push(checkbox);
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
            window.selectAllPages = function() {
                pageCheckboxes.forEach(cb => cb.checked = true);
            };
            
            window.deselectAllPages = function() {
                pageCheckboxes.forEach(cb => cb.checked = false);
            };
            
            window.confirmApplyToPages = function() {
                const selectedPages = pageCheckboxes
                    .filter(cb => cb.checked)
                    .map(cb => parseInt(cb.value));
                
                if (selectedPages.length === 0) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    return;
                }
                
                updateStatus('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ ' + selectedPages.length + ' —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö...');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                fetch(`/api/get_page_data?session_id=${sessionId}&page_num=${currentPage}`)
                    .then(res => res.json())
                    .then(currentData => {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
                        const promises = selectedPages.map(pageNum => {
                            return fetch('/api/apply_to_page', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    session_id: sessionId,
                                    source_page: currentPage,
                                    target_page: pageNum,
                                    data: currentData
                                })
                            });
                        });
                        
                        return Promise.all(promises);
                    })
                    .then(responses => {
                        return Promise.all(responses.map(r => r.json()));
                    })
                    .then(results => {
                        const successCount = results.filter(r => r.success).length;
                        updateStatus(`–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ ${successCount} —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö`);
                        alert(`–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ ${successCount} –∏–∑ ${selectedPages.length} —Å—Ç—Ä–∞–Ω–∏—Ü`);
                        closeApplyDialog();
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:', err);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + err.message);
                    });
            };
            
            window.closeApplyDialog = function() {
                document.body.removeChild(dialog);
                delete window.selectAllPages;
                delete window.deselectAllPages;
                delete window.confirmApplyToPages;
                delete window.closeApplyDialog;
            };
        }
    </script>
</body>
</html>

